<!--
Ukulele Tuesday – Break Timer + Donate (projector-ready)
Single-file HTML. Open in a browser (F11 for fullscreen).

URL params (optional):
  minutes   – total minutes for the countdown (default: 10)
  title     – headline (default: "Ukulele Tuesday will resume in")
  subtitle  – small line above timer (default: "We’re on a short break")
  ctaText   – button text (default: "Donate now")
  ctaUrl    – donation link (default: https://buymeacoffee.com/UkuleleTuesday)
  note      – line under the button (e.g., "Every €5 prints a songbook")

  qr        – "1" to show QR (default: 1)
  logo      – URL/path to a logo image (optional). Place a local file like logo.svg next to this HTML and pass ?logo=logo.svg

If you want this totally offline, the QR <img> uses a public QR service.
Ping me if you want me to swap in an embedded generator.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b1221" />
<title>Ukulele Tuesday – Break Timer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans:wght@400;500;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="wrap">
    <div>
      <section class="card" aria-live="polite">
        <header>
          <div class="brand">
            <img id="logo" alt="Ukulele Tuesday logo" style="display:none; margin-bottom: 8px;" />
            <div class="sub" id="subtitle">We’re on a short break</div>
            <h1 id="title">Ukulele Tuesday will resume in</h1>
          </div>
        </header>

        <div class="headline" id="headline">Tip: every €5 prints a songbook</div>
        <div class="timer" id="timer" role="timer" aria-live="polite">10:00</div>
        <div class="resume" id="resumeText" style="pointer-events: none;"></div>

        <div class="progress"><div class="bar" id="bar"></div></div>

        <div class="controls hidden" id="controls" style="margin-bottom: 1rem;">
          <div class="chip" id="pauseBtn">Pause</div>
          <div class="chip" id="plus1">+1 min</div>
          <div class="chip" id="minus1">−1 min</div>
          <div class="chip" id="extend30">+30 sec</div>
          <div class="chip" id="resetBtn">Reset</div>
          <div class="chip" id="wakeLockBtn">Awake: OFF</div>
        </div>
        
        <div class="cta-area">
          <div class="cta-small" id="ctaNote">Scan the QR code with your phone to donate</div>
          <div id="cta" class="cta-display">Donate now</div>
          <div id="qrWrap" class="qr" style="display:none;">
            <!-- QR Code will be generated here -->
          </div>
          <p id="qrUrl" class="cta-small"></p>
        </div>
      </section>
    </div>

    <footer>
    </footer>
  </div>


    <div id="toast" class="toast"></div>

  <script src="scripts/qrcode.min.js"></script>
  <script>
    const qs = new URLSearchParams(location.search);
    const defaults = {
      minutes: 10,
      title: 'will resume in',
      subtitle: '',
      headline: '',
      ctaText: 'SUPPORT US',
      qrCodeUrl: 'ukuleletuesday.ie/donate-qr',
      fallbackDonateUrl: 'ukuleletuesday.ie/donate',
      note: 'Time to grab a drink, tune up, chat to your neighbours... and hey, if you\'re having a good time, why not...',
      qr: '1',
      logo: 'ut-logo-wordmark-white.png',
      autostart: 'true'
    };

    const cfg = {
      minutes: parseFloat(qs.get('minutes') || qs.get('m') || defaults.minutes) || defaults.minutes,
      title: qs.get('title') || defaults.title,
      subtitle: qs.get('subtitle') || defaults.subtitle,
      headline: qs.get('headline') || defaults.headline,
      ctaText: qs.get('ctaText') || defaults.ctaText,
      qrCodeUrl: qs.get('ctaUrl') || defaults.qrCodeUrl,
      fallbackDonateUrl: qs.get('fallbackDonateUrl') || defaults.fallbackDonateUrl,
      note: qs.get('note') || defaults.note,
      qr: (qs.get('qr') || defaults.qr),
      logo: qs.get('logo') || defaults.logo,
      autostart: (qs.get('autostart') || defaults.autostart)
    };



    // Fill static text
    document.getElementById('title').textContent = cfg.title;
    const subtitleEl = document.getElementById('subtitle');
    if (cfg.subtitle) {
      subtitleEl.textContent = cfg.subtitle;
      subtitleEl.style.display = 'block';
    } else {
      subtitleEl.style.display = 'none';
    }
    const headlineEl = document.getElementById('headline');
    if (cfg.headline) {
      headlineEl.textContent = cfg.headline;
      headlineEl.style.display = 'block';
    } else {
      headlineEl.style.display = 'none';
    }
    document.getElementById('cta').textContent = cfg.ctaText;
    document.getElementById('ctaNote').textContent = cfg.note;

    // Logo (optional)
    if (cfg.logo){
      const l = document.getElementById('logo'); l.src = cfg.logo; l.style.display = 'block';
    }

    // QR (optional)
    const qrWrap = document.getElementById('qrWrap');
    const qrUrlEl = document.getElementById('qrUrl');
    if (cfg.qr !== '0'){
      qrWrap.innerHTML = ''; // Clear previous QR
      try {
        new QRCode(qrWrap, {
            text: cfg.qrCodeUrl,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        qrUrlEl.textContent = 'ukuleletuesday.ie/donate';
        qrWrap.style.display = 'grid';
        qrUrlEl.style.display = 'block';
      } catch (e) {
        console.error('QR code generation failed', e);
        qrWrap.textContent = 'Error generating QR code.';
        qrUrlEl.style.display = 'none';
      }
    }

    // Timer logic
    let totalMs = Math.max(0, Math.round(cfg.minutes * 60 * 1000));
    const startTotalMs = totalMs;
    let remainingMs = totalMs;
    let paused = cfg.autostart === 'false';
    let lastTs = performance.now();

    const timerEl = document.getElementById('timer');
    const resumeEl = document.getElementById('resumeText');
    const bar = document.getElementById('bar');

    const fmt = (ms)=>{
      const s = Math.max(0, Math.floor(ms/1000));
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${mm}:${ss}`;
    };

    const updateEcho = ()=>{
      const backAt = new Date(Date.now() + remainingMs);
      const opts = { hour: '2-digit', minute: '2-digit' };
      resumeEl.textContent = remainingMs>0 ? `Back at ${backAt.toLocaleTimeString([], opts)}` : '';
    }

    const render = ()=>{
      timerEl.textContent = fmt(remainingMs);
      const done = 1 - (remainingMs / Math.max(1,startTotalMs));
      bar.style.width = `${(done*100).toFixed(2)}%`;
      updateEcho();
      if (remainingMs <= 0){
        timerEl.classList.add('back','blink');
        timerEl.textContent = 'WE\u2019RE BACK!';
        resumeEl.textContent = '';
        document.getElementById('headline').textContent = 'Grab your uke! Let\u2019s play.';
      }
    };

    const tick = (ts)=>{
      if (!paused && remainingMs>0){
        const dt = ts - lastTs;
        remainingMs = Math.max(0, remainingMs - dt);
        render();
      }
      lastTs = ts;
      requestAnimationFrame(tick);
    };

    // Controls
    function addMs(ms){ remainingMs = Math.max(0, remainingMs + ms); totalMs = Math.max(0, totalMs + ms); render(); }
    
    // Controls visibility management
    const controlsEl = document.getElementById('controls');
    let controlsVisible = false;
    
    function showControls() {
      if (!controlsVisible) {
        controlsEl.classList.remove('hidden');
        controlsVisible = true;
      }
    }
    
    function hideControls() {
      if (controlsVisible) {
        controlsEl.classList.add('hidden');
        controlsVisible = false;
      }
    }
    
    function setPaused(p){ 
      paused = p; 
      document.getElementById('pauseBtn').textContent = p ? 'Resume' : 'Pause';
      if (p) {
        showControls(); // Show controls when paused
      } else {
        hideControls(); // Hide controls when resumed
      }
    }

    document.getElementById('pauseBtn').addEventListener('click', ()=> setPaused(!paused));
    document.getElementById('plus1').addEventListener('click', ()=> addMs(60_000));
    document.getElementById('minus1').addEventListener('click', ()=> addMs(-60_000));
    document.getElementById('extend30').addEventListener('click', ()=> addMs(30_000));
    document.getElementById('resetBtn').addEventListener('click', ()=>{ remainingMs = totalMs = startTotalMs; timerEl.classList.remove('back','blink'); render(); });



    // --- iPad/mobile enhancements ---
    const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints>0;

    // Toast helper
    const toastEl = document.getElementById('toast');
    function showToast(txt){ if(!toastEl) return; toastEl.textContent = txt; toastEl.style.display='block'; clearTimeout(showToast.t); showToast.t=setTimeout(()=>toastEl.style.display='none', 900); }

    // Wake Lock toggle
    let wakeLock = null, wakeOn = false; const wakeBtn = document.getElementById('wakeLockBtn');
    async function setWake(on){
      if (!('wakeLock' in navigator)) { showToast('No Wake Lock'); return; }
      try{
        if (on && !wakeLock){
          wakeLock = await navigator.wakeLock.request('screen');
          wakeBtn.textContent = 'Awake: ON';
          wakeLock.addEventListener('release', ()=>{ wakeBtn.textContent='Awake: OFF'; wakeLock=null; });
        } else if (!on && wakeLock){
          await wakeLock.release(); wakeBtn.textContent='Awake: OFF'; wakeLock=null;
        }
      }catch(e){ showToast('Wake Lock error'); }
    }
    wakeBtn?.addEventListener('click', ()=>{ wakeOn=!wakeOn; setWake(wakeOn); });
    document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='visible' && wakeOn && !wakeLock){ setWake(true); } });

    // Touch gesture (tap = pause/resume only)
    function isInteractive(target){ 
      return target.closest('.controls, .chip, a, .qr, .cta-area') || 
             target.matches('.controls, .chip, a, .qr, .cta-area');
    }

    document.addEventListener('touchend', (e)=>{
      if (isInteractive(e.target)) return;
      setPaused(!paused);
      e.preventDefault(); // Prevent the subsequent click event
    }, {passive:false}); // Must be non-passive to call preventDefault

    // Mouse click support for non-touch devices
    document.addEventListener('click', (e) => {
      if (isInteractive(e.target)) return;
      setPaused(!paused);
    });

    // Initialize the pause state and controls visibility
    setPaused(paused);
    
    render();
    requestAnimationFrame(tick);
  </script>
</body>
</html>
